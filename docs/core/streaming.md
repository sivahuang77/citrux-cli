# 🌊 SSE 流式傳輸與工具調用 (Streaming Architecture)

Citrux
CLI 搭載了自研的高效能流式解析引擎，特別針對非 Google 模型（如 OpenAI 與 DeepSeek）的長文本輸出與複雜工具調用進行了深度優化。

## 🚀 SSE 解析技術

不同於一般的 Web 應用程式，終端介面對輸出的即時性要求極高。Citrux 的引擎具有以下特點：

- **真正的異步串流**：採用 Node.js `readline`
  模組配合 SSE 解析器，實現了字元級別的即時渲染。
- **斷斷續續防護**：在網路不穩定的情況下，引擎能自動緩衝並合併不完整的資料包，防止終端出現閃爍。

## 🛠️ 工具調用積累 (Tool Call Accumulation)

這是 Citrux
CLI 的一項原創優化。在流式輸出中，LLM 會以碎片化的方式回傳 JSON 格式的工具參數。如果直接解析，常會因為 JSON 不完整而失敗。

Citrux 採用了**「積累式解析技術」**：

1.  **偵測起始**：精確識別工具調用的 JSON 標籤。
2.  **狀態緩衝**：在後台累積參數字串，同時在 UI 顯示「思考中」動畫。
3.  **完整校驗**：僅在接收到完整的結尾標籤後，才執行語法驗證並觸發本地工具執行。

## 📊 Token 監控與預估

Citrux CLI 內建了多供應商通用的 Token 計量器：

- **OpenAI/DeepSeek**：解析 API 回傳的 `usage` 欄位以獲取精確數字。
- **本地預估**：在傳送請求前，基於字元分佈進行 Token 數量預估，防止超出上下文視窗限制。

---

_下一步：[查看內建工具手冊](../tools/overview.md)_
